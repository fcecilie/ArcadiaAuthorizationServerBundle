# ArcadiaAuthorizationBundle

Installation
============

Make sure Composer is installed globally, as explained in the
[installation chapter](https://getcomposer.org/doc/00-intro.md)
of the Composer documentation.

Applications that use Symfony Flex
----------------------------------

Open a command console, enter your project directory and execute:

```console
$ composer require arcadia/authorization-bundle
```

Applications that don't use Symfony Flex
----------------------------------------

### Step 1: Download the Bundle

Open a command console, enter your project directory and execute the
following command to download the latest stable version of this bundle:

```console
$ composer require arcadia/authorization-bundle
```

### Step 2: Enable the Bundle

Then, enable the bundle by adding it to the list of registered bundles
in the `config/bundles.php` file of your project:

```php
// config/bundles.php

return [
    // ...
    Arcadia\Bundle\AuthorizationBundle::class => ['all' => true],
];
```

Usage
=====

The bundle must be installed on each side (client & server)

### Server side

Start by creating a client representation by running `php bin/console arcadia:token-user:create client-1`.
The `arcadia:token-user:create` do 2 things : 
- It create a new TokenUser entity
- It generate a key in **'%kernel.projectDir%/config/authorization/'** that you must not share to anyone.

```php
// php bin/console arcadia:token-user:list
+----------+----------------------------------------------------------------------------------------------------------------------------------+------------+
| username | password                                                                                                                         | roles      |
+----------+----------------------------------------------------------------------------------------------------------------------------------+------------+
| client-1 | 2f615b4758c7815b7474f4fc737acdad2c706d6fff8a44892faaf5a028d25dcaaa344079257345842fa6383d71c76a14d897362811b8b986b2388ace6bbc906b | ROLE_TOKEN |
+----------+----------------------------------------------------------------------------------------------------------------------------------+------------+

```

Once it's done, configure your security.yaml

1) First step is to create a new provider :
```yaml
security:
    providers:
        arcadia_provider:
            entity:
                class: Arcadia\Bundle\AuthorizationBundle\Entity\TokenUser
                property: username
```

2) Next step is to create a new firewall with the `TokenAuthenticator` authenticator :

```yaml
security:
    firewalls:
        api:
            pattern: ^/api
            anonymous: false
            provider: arcadia_provider
            guard:
                authenticators:
                    - Arcadia\Bundle\AuthorizationBundle\Security\TokenAuthenticator
```

### Client side

Start by configuring the servers you want your client able to communicate with :
- Copy the client username
- Copy the client password
- Put a ttl (datetime format) to expire the token once the date is passed
```yaml
# config/packages/arcadia_authorization.yaml
arcadia_authorization:
    keys_path: '%kernel.project_dir%/config/authorization'

    servers:
        server-1:
            username: 'client-1'
            password: '2f615b4758c7815b7474f4fc737acdad2c706d6fff8a44892faaf5a028d25dcaaa344079257345842fa6383d71c76a14d897362811b8b986b2388ace6bbc906b'
            ttl: '+3 min'

```

Copy the key generated on server side into the client side at the path specified into the configuration (keys_path) and name it with the server name (here `config/authorization/server-1.pem`)

Once it's done, you can call the server by passing the X-Auth-Token header that can be generated by the TokenEncoder service : 
```php

class SomeHttpClient
{
    private TokenEncoder $tokenEncoder;
    private HttpClientInterface $client;

    public function __construct(HttpClientInterface $client, TokenEncoder $tokenEncoder)
    {
        $this->client = $client;
        $this->tokenEncoder = $tokenEncoder;
    }

    public function getApiResponse(): ResponseInterface
    {
        $response = $this->client->request('GET', "https://some-domain.com/api/response", [
            'headers' => ['X-Auth-Token' => $this->tokenEncoder->encode('server-1')]
        ]);
        
        return $response;
    }
}
```